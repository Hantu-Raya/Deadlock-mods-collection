(function () { 'use strict'; const r = $.GetContextPanel(); let hb = r.FindChildTraverse('unit_healthbar_lagging') || r.FindChildTraverse('health_bar') || r.FindChildTraverse('unit_health') || r.FindChildTraverse('hero_health_lagging'); if (!hb) return; const C1 = 'rgb(255,201,97)', C2 = 'rgb(100,133,252)', CM = 'rgb(255,123,0)', CN = 'rgb(91,239,181)', CW = '#ffffff', CE = '#e16161', CL_BAR = 'low_hp_bar_pulse', CL_TXT = 'low_hp_text_large', CL_ULT = 'low_hp_ult_static', DI = 0.15, FI = 0.4, NI = 1.5, II = 1.0, IT = 2000, CI = 2000, FT = 0.97, LT = 25, HT = 3, MA = 10; let pc = false, pa = 0, cp = null, us = null, hc = null, pl = null, cb = null, cbp = null, ui = null, ct = 0, cf = 0, lc = null, luc = null, ltc = null, lhp = -1, lw = -1, lpw = -1, lt = null, lsh = -1, lsm = -1, cm = 0, lcc = 0, lct = 0, llp = -1, sc = 0, pp = -1, pm = false, lv = null; function sA(p) { let t = 0, f = 0, d = 0, c = p; while (c && d < 10) { if (typeof c.BHasClass === 'function') { if (!t) { if (c.BHasClass('team2')) t = 2; else if (c.BHasClass('team1')) t = 1; } if (!(f & 1) && c.BHasClass('enemy')) f |= 1; if (!(f & 2) && (c.BHasClass('team_neutral') || c.BHasClass('neutral'))) f |= 2; if (t && (f & 3)) break; } if (typeof c.GetParent !== 'function') break; c = c.GetParent(); d++; } ct = t; cf = f; } function cP() { if (pc) return true; if (pa >= MA) return false; pa++; if (!us || !us.IsValid()) { us = r.FindChildTraverse('UnitStatus'); if (!us) return false; } if (!hc || !hc.IsValid()) hc = us.FindChildTraverse('hp_counter'); if (!pl || !pl.IsValid()) pl = us.FindChildTraverse('unit_healthbar_pip_label'); if (!cb || !cb.IsValid()) cb = us.FindChildTraverse('unit_healthbar_lagging'); if (cb && (!cbp || !cbp.IsValid())) cbp = cb.GetParent(); if (pl && cb && cbp) { pc = true; return true; } return false; } function pM(t) { if (t === lt) return cm; lt = t; let p = 0, q = 0, n = t.length, lp = t.lastIndexOf('|'); for (let i = 0; i < n; i++) { let c = t.charCodeAt(i); if (c === 124) p++; else if ((c === 34 || c === 39) && (lp === -1 || i > lp)) q++; } cm = p * 500 + q * 100; return cm; } function sC(c) { if (lc === c) return; hb.style.washColor = c; lc = c; } function sU(c) { if (!ui || !ui.IsValid()) ui = $('#unit_ult_ready_icon') || $('#ult_icon') || $('#ability_ult'); if (!ui || !ui.style) return; if (luc === c) return; ui.style.washColor = c; luc = c; } function sT(c) { if (!hc || !hc.style) return; if (ltc === c) return; hc.style.washColor = c; ltc = c; } function uH(ch, mh) { if (!hc) return; if (ch === lsh && mh === lsm) return; if (lv !== 'visible') { hc.style.visibility = 'visible'; lv = 'visible'; } let t = ch + ' / ' + mh; try { if (hc.text !== t) hc.text = t; } catch (e) { try { hc.SetAttributeString('text', t); } catch (e2) { } } lsh = ch; lsm = mh; } function u() { let n = Date.now(); if (!pc) { if (!cP()) { $.Schedule(0.15, u); return; } } if (typeof hb.GetParent === 'function') { let p = hb.GetParent(); if (cp !== p) cp = p; } if (n - lcc > CI) { lcc = n; sA(hb); } if (cf & 2) { sC(CN); sT(CW); lct = n; $.Schedule(NI, u); return; } if (!(cf & 1)) { lct = n; $.Schedule(FI, u); return; } let w = hb.actuallayoutwidth | 0, pw = (cp && cp.actuallayoutwidth !== undefined) ? cp.actuallayoutwidth | 0 : 0; if (w === lw && pw === lpw) { if (n - lct > IT) { $.Schedule(II, u); return; } $.Schedule(DI, u); return; } lw = w; lpw = pw; lct = n; if (pw <= 0) { $.Schedule(0.18, u); return; } let hp = ((w / pw) * 100) | 0; if (Math.abs(hp - lhp) < HT && hp > LT) { $.Schedule(DI, u); return; } if (hp === pp) sc++; else { sc = 0; pp = hp; } lhp = hp; let tx = ''; if (pl) { try { tx = pl.text || pl.GetAttributeString('text', ''); } catch (e) { tx = ''; } } let ch = 0, mh = 0; if (cb && cbp) { let bw = cb.actuallayoutwidth || 0, pbw = cbp.actuallayoutwidth || 0, rt = pbw > 0 ? bw / pbw : 0; mh = pM(tx); ch = rt >= FT ? mh : Math.round(mh * rt); } uH(ch, mh); let si = DI; if (hp <= LT) { if (!hb || !hb.IsValid()) { $.Schedule(0.15, u); return; } if (!pm) { hb.AddClass(CL_BAR); if (hc) hc.AddClass(CL_TXT); if (!ui || !ui.IsValid()) ui = $('#unit_ult_ready_icon') || $('#ult_icon') || $('#ability_ult'); if (ui) ui.AddClass(CL_ULT); pm = true; lc = null; luc = null; ltc = null; } sT(CE); sU(CE); if (llp === -1 || Math.abs(hp - llp) >= 5) { llp = hp; sc = 0; } si = DI; } else { if (pm) { hb.RemoveClass(CL_BAR); if (hc) hc.RemoveClass(CL_TXT); if (!ui || !ui.IsValid()) ui = $('#unit_ult_ready_icon') || $('#ult_icon') || $('#ability_ult'); if (ui) ui.RemoveClass(CL_ULT); pm = false; ltc = null; luc = null; } let c = hp <= 65 ? CM : ct === 1 ? C1 : ct === 2 ? C2 : C1; sC(c); sU(c); sT(CW); llp = hp; if (sc >= 5) { let tf = Math.floor(sc / 5); si = Math.min(DI * Math.pow(2, tf), II); } } $.Schedule(si, u); } u(); })();